services:
  db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
      - ./db/seed.sql:/docker-entrypoint-initdb.d/02_seed.sql:ro
    networks: [app-net]

  redis:
    image: redis:7
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redisdata:/data
    networks: [app-net]

  api:
    build: ./api
    restart: unless-stopped
    env_file: .env
    environment:
      - DATABASE_URL=postgresql+psycopg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:${POSTGRES_PORT}/${POSTGRES_DB}
      - ALLOWED_ORIGINS=${API_ALLOWED_ORIGINS}
      - BOOKING_CUTOFF_HOURS=${BOOKING_CUTOFF_HOURS}
      - CANCEL_CUTOFF_MINUTES=${CANCEL_CUTOFF_MINUTES}
      - NO_SHOW_GRACE_MINUTES=${NO_SHOW_GRACE_MINUTES}
      - REPORTING_RETENTION_MONTHS=${REPORTING_RETENTION_MONTHS}
    depends_on: [db, redis]
    networks: [app-net]

  web:
    build: ./web
    restart: unless-stopped
    env_file: .env
    environment:
      - API_BASE=http://nginx/api
    depends_on: [api]
    networks: [app-net]

  nginx:
    image: nginx:1.27
    restart: unless-stopped
    depends_on: [web, api]
    ports:
      - "${PUBLIC_PORT_HTTP:-80}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    networks: [app-net]

networks:
  app-net:

volumes:
  pgdata:
  redisdata:
